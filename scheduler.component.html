

<div class="scheduler-container">
  <!-- Toast Notification -->
  <div *ngIf="toast" [class]="'toast toast-' + (toast.variant || 'success')">
    <div class="toast-title">{{ toast.title }}</div>
    <div class="toast-description">{{ toast.description }}</div>
  </div>



  <!-- STEP 1: IMPORT -->
  <div *ngIf="currentStep === 'import'" class="card">
    <h2>Load Exam Data</h2>

    <!-- Term & School Year Selection -->
    <div class="section api-section">
      <h3> Select Term & School Year</h3>
      
      <div class="form-row">
        <div class="form-group">
          <label>Term & School Year</label>
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Select Term & School Year</mat-label>
            <mat-select [(ngModel)]="activeTerm" name="activeTerm">
              <mat-option *ngFor="let item of combinedOptions" [value]="item.value">
                {{ item.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <!-- Single Load Button -->
      <div class="button-row">
        <button 
          mat-raised-button
          color="primary"
          class="btn btn-primary" 
          (click)="loadExamData()" 
          [disabled]="isLoadingApi || !activeTerm">
          <mat-icon>cloud_download</mat-icon>
          {{ isLoadingApi ? 'Loading...' : 'Load Exam Data from API' }}
        </button>
      </div>

      <!-- Status Messages -->
      <div class="status-container" *ngIf="exams.length > 0 || rooms.length > 0">
        <p *ngIf="exams.length > 0" class="success-text">‚úì {{ exams.length }} exams loaded</p>
        <p *ngIf="rooms.length > 0" class="success-text">‚úì {{ rooms.length }} rooms loaded</p>
      </div>
    </div>

    <!-- NEW: Number of Days Configuration -->
    <div class="section">
      <h3> Configure Exam Schedule</h3>
      <div class="form-row">
        <div class="form-group">
          <label>Number of Exam Days (1-5)</label>
          <input 
            type="number" 
            class="form-control" 
            [(ngModel)]="numberOfDays"
            (ngModelChange)="onNumberOfDaysChange()"
            min="1"
            max="5"
          />
        </div>
      </div>
    </div>
    
    <!-- Exam Dates -->
    <div class="section">
      <h3> Exam Dates</h3>
      <div class="form-row">
        <div class="form-group" *ngFor="let day of days; let i = index">
          <label>{{ day }}</label>
          <input 
            type="date" 
            class="form-control" 
            [(ngModel)]="examDates[i]"
          />
        </div>
      </div>
    </div>

    <button 
      class="btn btn-primary btn-lg" 
      (click)="generateExamSchedule()" 
      [disabled]="exams.length === 0">
      Generate Schedule
    </button>
    <button (click)="testMethods()">Test Methods</button>
  </div>


   <div class="main-layout" *ngIf="currentStep !== 'import' && generatedSchedule.length > 0">
    <!-- Sidebar Navigation -->
    <div class="top-nav">
  <div class="nav-left">
    <h1 class="app-title"> Exam Scheduler</h1>
  </div>

  <div class="nav-right">
    <button 
      class="nav-btn" 
      [class.active]="currentStep === 'generate'"
      (click)="goToStep('generate')">
      <mat-icon>list_alt</mat-icon>
      <span>Generated ({{ generatedSchedule.length }})</span>
    </button>

    <button 
      class="nav-btn"
      [class.active]="currentStep === 'summary'"
      (click)="viewCourseSummary()">
      <mat-icon>summarize</mat-icon>
      <span>Summary</span>
    </button>

    <button 
      class="nav-btn"
      [class.active]="currentStep === 'timetable'"
      (click)="viewRoomTimeTable()">
      <mat-icon>table_chart</mat-icon>
      <span>Time Table</span>
    </button>
<button (click)="analyzeRoomCapacity()" class="btn btn-info">
  üîç Analyze Room Capacity
</button>
    <button 
      class="nav-btn"
      [class.active]="currentStep === 'coursegrid'"
      (click)="viewCourseGrid()">
      <mat-icon>grid_on</mat-icon>
      <span>Course Grid</span>
    </button>

    <button 
      class="nav-btn"
      [class.active]="currentStep === 'proctor'"
      (click)="viewProctorAssignments()">
      <mat-icon>assignment_ind</mat-icon>
      <span>Proctors</span>
    </button>

    <button 
      class="nav-btn warning"
      *ngIf="getUnscheduledCount() > 0"
      (click)="openUnscheduledPanel()">
      <mat-icon>warning</mat-icon>
      <span>Unscheduled ({{ getUnscheduledCount() }})</span>
    </button>

    <button class="nav-btn back" (click)="goToStep('import')">
      <mat-icon>arrow_back</mat-icon>
      <span>Import</span>
    </button>
  </div>
</div>

    <!-- Main Content Area -->
    <div class="content-area">
      

  <!-- STEP 2: GENERATED SCHEDULE -->
  <div *ngIf="currentStep === 'generate'" class="card">
    
    <div class="card-header">
        <h2>Generated Schedule</h2>
        <div class="button-group">
            <button class="btn btn-outline" (click)="downloadScheduleCSV()">
              üíæ Download CSV
            </button>
            <button 
              class="btn"
              [class.btn-warning]="getTotalConflicts() > 0"
              [class.btn-success]="getTotalConflicts() === 0"
              (click)="showConflictPanel = true">
              <mat-icon>{{ getTotalConflicts() > 0 ? 'warning' : 'check_circle' }}</mat-icon>
              Exams with No Rooms
              <span class="badge" *ngIf="getTotalConflicts() > 0">{{ getTotalConflicts() }}</span>
            </button>
        </div>
    </div>

    <p class="subtitle">{{ generatedSchedule.length }} exams scheduled</p>

    <!-- NEW: Search Bar -->
    <div class="enhanced-filter-section">
        <div class="filter-row">
            <mat-form-field appearance="outline" class="search-field-wide">
                <mat-label>üîç Search exams...</mat-label>
                <input 
                    matInput 
                    [(ngModel)]="searchQuery" 
                    (ngModelChange)="applyGeneratedFilters()"
                    placeholder="Search by code, subject, title, instructor, or department"
                />
                <button mat-icon-button matSuffix *ngIf="searchQuery" (click)="searchQuery=''; applyGeneratedFilters()">
                    <mat-icon>close</mat-icon>
                </button>
            </mat-form-field>
        </div>

        <!-- Cascading Filters -->
        <div class="filter-row">
            <!-- Step 1: Department -->
            <div class="filter-group">
                <mat-form-field appearance="outline">
                    <mat-label>üèõÔ∏è Step 1: Select Department</mat-label>
                    <mat-select 
                        [(ngModel)]="selectedGeneratedDept"
                        (selectionChange)="onGeneratedDeptChange()">
                        <mat-option value="">All Departments</mat-option>
                        <mat-option *ngFor="let dept of uniqueGeneratedDepartments" [value]="dept">
                            {{ dept }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
            </div>

            <!-- Step 2: Program -->
            <div class="filter-group">
                <mat-form-field appearance="outline">
                    <mat-label>üìö Step 2: Select Program</mat-label>
                    <mat-select 
                        [(ngModel)]="selectedGeneratedCourse"
                        (selectionChange)="onGeneratedCourseChange()"
                        [disabled]="!selectedGeneratedDept">
                        <mat-option value="">All Programs</mat-option>
                        <mat-option *ngFor="let course of availableGeneratedCourses" [value]="course">
                            {{ course }}
                        </mat-option>
                    </mat-select>
                    <mat-hint *ngIf="!selectedGeneratedDept">Select a department first</mat-hint>
                </mat-form-field>
            </div>

            <!-- Step 3: Year -->
            <div class="filter-group">
                <mat-form-field appearance="outline">
                    <mat-label>üéì Step 3: Select Year Level</mat-label>
                    <mat-select 
                        [(ngModel)]="selectedGeneratedYear"
                        (selectionChange)="applyGeneratedFilters()"
                        [disabled]="!selectedGeneratedCourse">
                        <mat-option [value]="null">All Years</mat-option>
                        <mat-option *ngFor="let year of availableGeneratedYears" [value]="year">
                            Year {{ year }}
                        </mat-option>
                    </mat-select>
                    <mat-hint *ngIf="!selectedGeneratedCourse">Select a program first</mat-hint>
                </mat-form-field>
            </div>

            <!-- Clear Filters Button -->
            <button 
                class="btn btn-outline-sm" 
                (click)="clearGeneratedFilters()"
                *ngIf="selectedGeneratedDept || selectedGeneratedCourse || selectedGeneratedYear || searchQuery">
                <mat-icon>clear_all</mat-icon>
                Clear Filters
            </button>
        </div>

        <!-- Results Count -->
        <div class="results-info">
            <mat-icon>info</mat-icon>
            <span>Showing {{ filteredSchedule.length }} of {{ generatedSchedule.length }} exams</span>
        </div>
    </div>

    <div class="table-responsive">
      <table class="data-table">
        <thead>
          <tr>
            <th>Code</th>
            <th>Subject ID</th>
            <th>Title</th>
            <th>Course</th>
            <th>Course Department</th>
            <th>Year Level</th>
            <th>Instructor</th>
            <th>Subject Department</th>
            <th>Day</th>
            <th>Time</th>
            <th>Room</th>
            <th>Actions</th>
          </tr>
        </thead>

        <!-- TABLE BODY -->
        <tbody>
          <tr *ngFor="let exam of displayedSchedule; let idx = index; trackBy: trackByExam"
    [class.conflict-row]="currentStep === 'generate' ? exam.HAS_ROOM_CONFLICT : exam.HAS_PROCTOR_CONFLICT">

            
            <!-- CODE -->
            <td>
              <mat-icon *ngIf="exam.HAS_ROOM_CONFLICT" class="conflict-indicator" title="This exam has conflicts">
                warning
              </mat-icon>
              <input *ngIf="editingRow === idx" class="form-control-sm" [(ngModel)]="editedExam.CODE"/>
              <span *ngIf="editingRow !== idx">{{ exam.CODE }}</span>
            </td>

            <td>{{ exam.SUBJECT_ID }}</td>

            <td class="truncate">{{ exam.DESCRIPTIVE_TITLE }}</td>

            <td>{{ exam.COURSE }}</td>

            <td>{{ exam.DEPT_SUB }}</td>

            <td><span class="year-level-badge">{{ exam.YEAR_LEVEL }}</span></td>

            <td>{{ exam.INSTRUCTOR }}</td>

            <td>{{ exam.DEPT }}</td>

            <!-- DAY -->
            <td>
              <div *ngIf="editingRow === idx" class="edit-step-container">
                <div class="step-label"><span class="step-number">1</span><span class="step-text">Select Day</span></div>
                <mat-form-field appearance="outline" class="edit-field">
                  <mat-label>Choose Day</mat-label>
                  <mat-select [(ngModel)]="editedExam.DAY" (ngModelChange)="onEditDayChange()">
                    <mat-option value="">-- Select Day --</mat-option>
                    <mat-option *ngFor="let d of days; let i = index" [value]="d">
                      <div class="day-option">
                        <span class="day-name">{{ d }}</span>
                        <span class="day-date" *ngIf="examDates[i]">{{ examDates[i] | date:'MMM dd' }}</span>
                      </div>
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
              <span *ngIf="editingRow !== idx" class="display-value">{{ exam.DAY }}</span>
            </td>

            <!-- TIME -->
            <td>
              <div *ngIf="editingRow === idx" class="edit-step-container">
                <div class="step-label">
                  <span class="step-number" [class.disabled]="!editedExam.DAY">2</span>
                  <span class="step-text">Select Time</span>
                </div>

                <mat-form-field appearance="outline" class="edit-field">
                  <mat-label>Choose Time Slot</mat-label>
                  <mat-select 
                    [(ngModel)]="editedExam.SLOT"
                    (ngModelChange)="onEditSlotChange()"
                    [disabled]="!editedExam.DAY || availableSlots.length === 0">
                    <mat-option value="">-- Select Time --</mat-option>
                    <mat-option *ngFor="let s of availableSlots" [value]="s">
                      <div class="time-option">
                        <mat-icon class="time-icon">schedule</mat-icon>
                        <span>{{ s }}</span>
                      </div>
                    </mat-option>
                  </mat-select>

                  <mat-hint *ngIf="!editedExam.DAY">Select a day first</mat-hint>
                  <mat-hint *ngIf="editedExam.DAY && availableSlots.length === 0" class="warning-hint">No available slots</mat-hint>
                  <mat-hint *ngIf="editedExam.DAY && availableSlots.length > 0" class="success-hint">
                    {{ availableSlots.length }} slots available
                  </mat-hint>
                </mat-form-field>
              </div>

              <span *ngIf="editingRow !== idx" class="display-value">{{ getMergedTimeDisplay(exam) }}</span>
            </td>

            <!-- ROOM -->
            <td>
              <div *ngIf="editingRow === idx" class="edit-step-container">
                <div class="step-label">
                  <span class="step-number" [class.disabled]="!editedExam.SLOT">3</span>
                  <span class="step-text">Select Room</span>
                </div>

                <mat-form-field appearance="outline" class="edit-field">
                  <mat-label>Choose Room</mat-label>
                  <mat-select 
                    [(ngModel)]="editedExam.ROOM"
                    [disabled]="!editedExam.SLOT || availableRooms.length === 0">

                    <mat-option value="">-- Select Room --</mat-option>

                    <mat-option *ngFor="let r of availableRooms" [value]="r">
                      <div class="room-option">
                        <mat-icon class="room-icon" [class.recommended]="getRoomRecommendation(editedExam, r)">
                          {{ getRoomRecommendation(editedExam, r) ? 'star' : 'meeting_room' }}
                        </mat-icon>
                        <span [class.recommended-text]="getRoomRecommendation(editedExam, r)">Room {{ r }}</span>
                        <span class="room-badge" *ngIf="getRoomRecommendation(editedExam, r)">Dept Match</span>
                      </div>
                    </mat-option>
                  </mat-select>

                  <mat-hint *ngIf="!editedExam.SLOT">Select a time slot first</mat-hint>
                  <mat-hint *ngIf="editedExam.SLOT && availableRooms.length === 0" class="warning-hint">
                    ‚ö†Ô∏è No available rooms for this slot
                  </mat-hint>
                  <mat-hint *ngIf="editedExam.SLOT && availableRooms.length > 0" class="success-hint">
                    ‚úì {{ availableRooms.length }} rooms available
                    <span *ngIf="hasRecommendedRooms(editedExam)"> | ‚≠ê Department matches shown first</span>
                  </mat-hint>
                </mat-form-field>
              </div>

              <span *ngIf="editingRow !== idx" class="display-value">{{ exam.ROOM }}</span>
            </td>

            <!-- ACTIONS -->
            <td>
              <div *ngIf="editingRow === idx" class="action-buttons">
                <button class="btn-icon btn-success" (click)="saveEdit()" title="Save changes">‚úì</button>
                <button class="btn-icon btn-danger" (click)="cancelEdit()" title="Cancel editing">‚úó</button>
              </div>

              <button *ngIf="editingRow !== idx" 
                class="btn-icon" 
                (click)="startEdit(idx)"
                title="Edit this exam">
                ‚úèÔ∏è
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="mt-3">
      <button 
        (click)="openUnscheduledPanel()"
        class="relative px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">
        üìã Unscheduled Exams
        <span *ngIf="getUnscheduledCount() > 0"
          class="absolute top-0 right-0 bg-red-600 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center">
          {{ getUnscheduledCount() }}
        </span>
      </button>
    </div>

  </div>
    <!-- CONFLICT PANEL -->
<!-- CONFLICT PANEL -->
<!-- CONFLICT PANEL -->
<div *ngIf="showConflictPanel" class="conflict-overlay" (click)="showConflictPanel = false">
  <div class="conflict-panel" (click)="$event.stopPropagation()">
    <div class="conflict-header">
      <h2>
        <mat-icon>warning</mat-icon>
        {{ currentStep === 'generate' ? 'Schedule Conflicts' : 'Proctor Conflicts' }}
      </h2>
      <button class="btn-close" (click)="showConflictPanel = false">‚úï</button>
    </div>

    <div class="conflict-content">
      
      <!-- ROOM CONFLICTS (Show in Generated Schedule view) -->
      <div class="conflict-section critical" 
           *ngIf="currentStep === 'generate' && conflictDetails.roomConflicts.length > 0">
        <h3>
          <mat-icon class="conflict-icon">meeting_room</mat-icon>
          Room Conflicts ({{ conflictDetails.roomConflicts.length }})
        </h3>
        <p class="conflict-description critical-text">
          üö® CRITICAL: Same room assigned to multiple exams at the same time
        </p>
        
        <div class="conflict-item" *ngFor="let conflict of conflictDetails.roomConflicts">
          <div class="conflict-item-header">
            <strong>Room {{ conflict.room }}</strong>
            <span class="conflict-time">{{ conflict.day }} | {{ conflict.slot }}</span>
          </div>
          <div class="conflict-exams">
            <div class="conflict-exam-card" *ngFor="let exam of conflict.exams">
              <span class="exam-code">{{ exam.CODE }}</span>
              <span class="exam-title">{{ exam.DESCRIPTIVE_TITLE }}</span>
              <span class="exam-course">{{ exam.COURSE }}</span>
              <span class="exam-instructor">{{ exam.INSTRUCTOR }}</span>
            </div>
          </div>
        </div>
      </div>

      

      <!-- NO CONFLICTS -->
      <div class="no-conflicts" *ngIf="getTotalConflicts() === 0">
        <mat-icon class="success-icon">check_circle</mat-icon>
        <h3>No Conflicts Found!</h3>
        <p *ngIf="currentStep === 'generate'">
          All exams are properly scheduled. No room conflicts detected.
        </p>
        <p *ngIf="currentStep === 'proctor'">
          All proctors are properly assigned. No conflicts detected.
        </p>
      </div>
    </div>
  </div>
</div>
  </div>


<!-- UNSCHEDULED EXAMS PANEL -->
<div *ngIf="showUnscheduledPanel" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-auto">
    
    <!-- Header -->
    <div class="sticky top-0 bg-gradient-to-r from-yellow-500 to-yellow-600 text-white p-6 border-b">
      <div class="flex justify-between items-center">
        <h2 class="text-2xl font-bold">üìã Unscheduled Exams</h2>
        <button 
          (click)="closeUnscheduledPanel()"
          class="text-2xl leading-none hover:text-yellow-100">
          ‚úï
        </button>
      </div>
      <p class="text-yellow-100 mt-2">Total: {{ unscheduledExams.length }} exam(s)</p>
    </div>

    <!-- Content -->
    <div class="p-6">
      <div *ngIf="unscheduledExams.length === 0" class="text-center py-8">
        <p class="text-gray-500 text-lg">‚úÖ No unscheduled exams</p>
      </div>

      <!-- Exam List -->
      <div *ngIf="!editingUnscheduledExam" class="space-y-4">
        <div *ngFor="let exam of unscheduledExams" class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
            <div>
              <p class="text-xs text-gray-500 uppercase">Code</p>
              <p class="text-lg font-bold">{{ exam.code }}</p>
            </div>
            <div>
              <p class="text-xs text-gray-500 uppercase">Subject</p>
              <p class="text-lg font-semibold">{{ exam.subjectId }}</p>
            </div>
            <div class="md:col-span-2">
              <p class="text-xs text-gray-500 uppercase">Title</p>
              <p class="text-sm">{{ exam.title }}</p>
            </div>
          </div>

          <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm mb-4">
            <div>
              <p class="text-xs text-gray-500">Course</p>
              <p class="font-semibold">{{ exam.course }}</p>
            </div>
            <div>
              <p class="text-xs text-gray-500">Year</p>
              <p class="font-semibold">{{ exam.yearLevel }}</p>
            </div>
            <div>
              <p class="text-xs text-gray-500">Lec</p>
              <p class="font-semibold">{{ exam.lec || 0 }}</p>
            </div>
            <div>
              <p class="text-xs text-gray-500">OE</p>
              <p class="font-semibold">{{ exam.oe || 0 }}</p>
            </div>
          </div>

          <div class="flex gap-2">
            <button (click)="deleteUnscheduledExam(exam)" class="px-3 py-1 bg-red-500 text-white text-sm rounded">üóëÔ∏è</button>
            <button (click)="editUnscheduledExam(exam)" class="px-3 py-1 bg-blue-500 text-white text-sm rounded">‚úèÔ∏è Edit</button>
          </div>
        </div>
      </div>

      <!-- Edit Form -->
      <div *ngIf="editingUnscheduledExam && editFormData" class="bg-blue-50 border-2 border-blue-300 rounded-lg p-6">
        <h3 class="text-xl font-bold mb-4">Editing: {{ editingUnscheduledExam.code }}</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Code</label>
            <input [(ngModel)]="editFormData.code" disabled class="w-full px-3 py-2 border rounded bg-gray-100" />
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Subject ID</label>
            <input [(ngModel)]="editFormData.subjectId" class="w-full px-3 py-2 border rounded" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold mb-1">Title</label>
            <input [(ngModel)]="editFormData.title" class="w-full px-3 py-2 border rounded" />
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Course</label>
            <input [(ngModel)]="editFormData.course" class="w-full px-3 py-2 border rounded" />
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Year Level</label>
            <input type="number" [(ngModel)]="editFormData.yearLevel" class="w-full px-3 py-2 border rounded" />
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Lec Units</label>
            <input type="number" [(ngModel)]="editFormData.lec" class="w-full px-3 py-2 border rounded" />
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">OE Units</label>
            <input type="number" [(ngModel)]="editFormData.oe" class="w-full px-3 py-2 border rounded" />
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Instructor</label>
            <input [(ngModel)]="editFormData.instructor" class="w-full px-3 py-2 border rounded" />
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Department</label>
            <input [(ngModel)]="editFormData.dept" class="w-full px-3 py-2 border rounded" />
          </div>
        </div>

        <div class="flex gap-2 justify-end">
          <button (click)="cancelEditUnscheduledExam()" class="px-4 py-2 bg-gray-400 text-white rounded">Cancel</button>
          <button (click)="saveAndRescheduleExam()" class="px-4 py-2 bg-green-500 text-white rounded">Save & Schedule</button>
        </div>
      </div>
    </div>
  </div>
</div>


  <!-- STEP 3: COURSE SUMMARY (ORGANIZED BY YEAR LEVEL) -->
  <div *ngIf="currentStep === 'summary'" class="card">
    <div class="card-header">
      <h2>Course Summary (Organized by Year Level)</h2>
      <!-- <button class="btnback" (click)="goToStep('generate')">
        ‚¨Ö Back
      </button> -->
    </div>

    <!-- NEW: Filter Section -->
    <div class="filter-section">
      <div class="form-row">
        <div class="form-group">
          <label>Filter by Course</label>
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Select Course</mat-label>
            <mat-select [(ngModel)]="selectedCourseFilter" (ngModelChange)="onCourseFilterChange()">
              <mat-option value="">All Courses</mat-option>
              <mat-option *ngFor="let course of uniqueCourses" [value]="course">
                {{ course }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        
        <div class="form-group" *ngIf="selectedCourseFilter">
          <label>Filter by Year Level</label>
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Select Year</mat-label>
            <mat-select [(ngModel)]="selectedYearFilter">
              <mat-option [value]="null">All Years</mat-option>
              <mat-option *ngFor="let year of availableYearsForCourse" [value]="year">
                Year {{ year }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <!-- NEW: Search Bar -->
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>üîç Search exams...</mat-label>
        <input 
          matInput 
          [(ngModel)]="searchQuery" 
          placeholder="Search by code, subject, title, instructor, or Department"
        />
        <button mat-icon-button matSuffix *ngIf="searchQuery || selectedCourseFilter" (click)="clearFilters()">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>
    </div>

    <div class="course-summary">
      <div *ngFor="let c of filteredCourseSummary" class="course-section">
        <h3 class="course-title">{{ c.course }}</h3>
        
        <!-- Loop through each year level group -->
        <div *ngFor="let yearGroup of c.yearLevelGroups" class="year-level-section">
          <div class="year-level-header">
            <span class="year-level-badge-large">Year {{ yearGroup.yearLevel }}</span>
          </div>
          
          <table class="data-table">
            <thead>
              <tr>
                <th>Day</th>
                <th>Time Slot</th>
                <th>Subject ID</th>
                <th>Title</th>
                <th>Code</th>
                <th>Room</th>
                <th>Instructor</th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngFor="let g of yearGroup.groups">
                <tr *ngFor="let ex of g.exams; let eIdx = index">
                  <td *ngIf="eIdx === 0" [attr.rowspan]="g.exams.length" class="group-cell">
                    <!-- NEW: Show day number instead of "Day X" -->
                    <strong>{{ getDayNumber(g.day) }}</strong>
                  </td>
                  <td *ngIf="eIdx === 0" [attr.rowspan]="g.exams.length" class="group-cell">
                    {{ g.slot }}
                  </td>
                  <td>{{ ex.SUBJECT_ID }}</td>
                  <td>{{ ex.DESCRIPTIVE_TITLE }}</td>
                  <td>{{ ex.CODE }}</td>
                  <td>{{ ex.ROOM }}</td>
                  <td>{{ ex.INSTRUCTOR }}</td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    
  </div>

  <!-- STEP 4: ROOM TIME TABLE (WITH YEAR LEVEL) -->
  <div *ngIf="currentStep === 'timetable'" class="card">
    <div class="card-header">
      <h2>Room-Time Table</h2>
      <!-- <button class="btnback" (click)="goToStep('summary')">
        ‚¨Ö Back
      </button> -->
    </div>

    <!-- Day Tabs -->
    <div class="tabs">
      <button 
        *ngFor="let day of roomTimeData.days; let i = index" 
        class="tab" 
        [class.active]="activeDay === day"
        (click)="activeDay = day">
        {{ day }}
        <span *ngIf="examDates[days.indexOf(day)]" class="badge">
          {{ examDates[days.indexOf(day)] }}
        </span>
      </button>
    </div>

    <!-- Time Table Grid -->
    <div class="table-responsive">
      <table class="timetable">
        <thead>
          <tr>
            <th class="sticky-col">Room</th>
            <th *ngFor="let slot of timeSlots">{{ slot }}</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let room of roomTimeData.rooms">
            <td class="sticky-col room-label">{{ room }}</td>
            <td *ngFor="let slot of timeSlots" 
                [style.background-color]="
  roomTimeData.table[activeDay] 
    && roomTimeData.table[activeDay][room] 
    && roomTimeData.table[activeDay][room][slot]
      ? getDeptColor(roomTimeData.table[activeDay][room][slot].dept)
      : 'transparent'
">

              <div *ngIf="
  roomTimeData.table[activeDay] 
    && roomTimeData.table[activeDay][room] 
    && roomTimeData.table[activeDay][room][slot]
" class="cell-content">
                <strong>{{ roomTimeData.table[activeDay][room][slot].code }}</strong>
                <small>{{ roomTimeData.table[activeDay][room][slot].course }}</small>
                <span class="year-level-badge-small">Yr {{ roomTimeData.table[activeDay][room][slot].yearLevel }}</span>
              </div>
              <span *ngIf="!(
  roomTimeData.table[activeDay] 
    && roomTimeData.table[activeDay][room] 
    && roomTimeData.table[activeDay][room][slot]
)" class="empty-cell">‚Äî</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Legend -->
    <div class="legend">
      <h4>Department Colors:</h4>
      <div class="legend-items">
        <span class="legend-item" style="background-color: #ef4444;">SACE</span>
        <span class="legend-item" style="background-color: #facc15; color: #000;">SABH</span>
        <span class="legend-item" style="background-color: #3b82f6;">SECAP</span>
        <span class="legend-item" style="background-color: #22c55e;">SHAS</span>
      </div>
    </div>


      
  </div>






<!-- REPLACE THE ENTIRE COURSE GRID SECTION WITH THIS -->

<!-- STEP 5: COURSE GRID - COMPLETELY FIXED -->
<div *ngIf="currentStep === 'coursegrid'" class="card">
  <div class="card-header">
    <h2>Course Grid Editor</h2>
    <!-- <button class="btnback" (click)="goToStep('summary')">‚¨Ö Back</button> -->
  </div>

  <!-- FILTERS -->
  <div class="filter-section">
    <div class="form-row">
      <div class="form-group">
        <label>Filter by Course</label>
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Select Course</mat-label>
          <mat-select [(ngModel)]="selectedCourseFilter" (ngModelChange)="onCourseFilterChange()">
            <mat-option value="">All Courses</mat-option>
            <mat-option *ngFor="let course of uniqueCourses" [value]="course">
              {{ course }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="form-group" *ngIf="selectedCourseFilter">
        <label>Filter by Year Level</label>
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Select Year</mat-label>
          <mat-select [(ngModel)]="selectedYearFilter">
            <mat-option [value]="null">All Years</mat-option>
            <mat-option *ngFor="let year of availableYearsForCourse" [value]="year">
              Year {{ year }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </div>

    <mat-form-field appearance="outline" class="search-field">
      <mat-label>üîç Search exams...</mat-label>
      <input 
        matInput 
        [(ngModel)]="searchQuery" 
        placeholder="Search by code, subject, title, or department"
      />
      <button mat-icon-button matSuffix *ngIf="searchQuery || selectedCourseFilter" (click)="clearFilters()">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
  </div>

  <!-- TABS -->
  <div class="enhanced-tabs">
    <button 
      *ngFor="let day of courseGridData.days; let i = index"
      class="enhanced-tab"
      [class.active]="activeDay === day"
      (click)="activeDay = day">
      <div class="tab-content">
        <span class="tab-day">{{ day }}</span>
        <span class="tab-date" *ngIf="examDates[days.indexOf(day)]">
          <mat-icon class="date-icon">event</mat-icon>
          {{ examDates[days.indexOf(day)] | date:'EEEE, MMM dd, yyyy' }}
        </span>
        <span class="tab-date-placeholder" *ngIf="!examDates[days.indexOf(day)]">
          <mat-icon class="date-icon">event_busy</mat-icon>
          No date set
        </span>
      </div>
    </button>
  </div>

  <!-- GRID TABLE -->
  <div class="table-responsive">
    <table class="enhanced-grid-table">
      <thead>
        <tr>
          <th class="sticky-col course-header">
            <div class="header-content">
              <mat-icon>school</mat-icon>
              <span>Course & Year</span>
            </div>
          </th>
          <th *ngFor="let slot of timeSlots" class="time-header">
            <div class="time-header-content">
              <mat-icon>schedule</mat-icon>
              <span>{{ slot }}</span>
            </div>
          </th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let courseObj of filteredCourseGridNonEmpty">
          <ng-container *ngFor="let yearObj of courseObj.years">
            <tr class="course-row">
              <td class="sticky-col course-year-cell">
                <div class="course-year-label">
                  <span class="course-name">{{ courseObj.course }}</span>
                  <span class="year-badge">Year {{ yearObj.year }}</span>
                </div>
              </td>

              <td *ngFor="let slot of timeSlots" class="exam-cell">
                <!-- HAS EXAMS -->
                <ng-container *ngIf="yearObj.slots[slot]?.length > 0">
                  <div 
                    *ngFor="let exam of yearObj.slots[slot]" 
                    class="enhanced-exam-card" 
                    [class.multi-slot-start]="isFirstSlotOfMultiSlot(exam)"
  [class.multi-slot-end]="isLastSlotOfMultiSlot(exam)"
  [class.multi-slot]="exam.IS_MULTI_SLOT"
                    [style.background]="getDeptGradient(exam.DEPT || exam.dept)">
                    
                    <div class="exam-card-header">
                      <div class="exam-header-left">
                        <mat-icon class="subject-icon">book</mat-icon>
                        <div class="subject-info">
                          <strong class="subject-id">{{ exam.SUBJECT_ID || exam.subjectId }}</strong>
                          
                          <!-- Multi-slot indicator -->
        <span *ngIf="exam.IS_MULTI_SLOT" class="multi-slot-badge">
          <mat-icon class="badge-icon">schedule</mat-icon>
          {{ exam.TOTAL_SLOTS }} slots
        </span>
      </div>
    </div>
  </div>

                    <div class="exam-card-body">
                      <div class="exam-detail">
                        <mat-icon class="detail-icon">meeting_room</mat-icon>
                        <span>Room {{ exam.ROOM || exam.room }}</span>
                      </div>
                      <div class="exam-detail">
                        <mat-icon class="detail-icon">badge</mat-icon>
                        <span>{{ exam.CODE || exam.code }}</span>
                      </div>
                    </div>

                    <div class="exam-card-actions">
                      <button class="btn-icon-sm" [title]="'Move ' + exam.title" (click)="showMoveOptions(getFullExam(exam, activeDay, slot), activeDay, slot)">üìç</button>
                  <!-- <button class="btn-icon-sm" [title]="'Remove ' + exam.title" (click)="removeExamByTitle(exam.title)">üóëÔ∏è</button> -->
                
                <button *ngIf="!exam.IS_MULTI_SLOT || exam.SLOT_INDEX === 0"
            class="btn-icon-sm" 
            [title]="'Remove ' + exam.DESCRIPTIVE_TITLE" 
            (click)="removeExamByCode(exam.CODE)">
      üóëÔ∏è
    </button>
                </div>
                  </div>
                </ng-container>

                <!-- EMPTY SLOT -->
                <div *ngIf="!yearObj.slots[slot] || yearObj.slots[slot].length === 0" class="empty-slot">
                  <mat-icon class="empty-icon">event_available</mat-icon>
                </div>
              </td>
            </tr>
          </ng-container>
        </ng-container>
      </tbody>
    </table>
  </div>

  <!-- ACTION BUTTONS -->
  
</div>


  <!-- MOVE EXAM POPUP -->
  <div *ngIf="movePopupVisible && moveExamData" class="move-popup">
    <h3>Move Exam: {{ moveExamData.DESCRIPTIVE_TITLE || moveExamData.title }}</h3>

    <div *ngIf="safeSlots.length > 0; else noSlots">
      <button *ngFor="let s of safeSlots" (click)="applyMove(s.day, s.slot)">
        {{ s.day }} - {{ s.slot }}
      </button>
    </div>

    <ng-template #noSlots>
      <p>No safe slots available.</p>
    </ng-template>

    <button (click)="closeMovePopup()">Cancel</button>
  </div>

<!-- STEP 6: ENHANCED PROCTOR ASSIGNMENT -->
<div *ngIf="currentStep === 'proctor'" class="card">
  <div class="card-header">
    <h2>Smart Proctor Assignment</h2>
    <div class="button-group">
      <!-- <button class="btnback" (click)="goToStep('coursegrid')">‚¨Ö Back</button> -->
      
      <!-- BULK ACTION BUTTONS -->
      <!-- <button class="btn btn-success" (click)="autoAssignAllProctors()">
        <mat-icon>auto_fix_high</mat-icon>
        Auto-Assign All Proctors
      </button> -->
      
      <button class="btn btn-warning" (click)="resetAllProctors()">
        <mat-icon>refresh</mat-icon>
        Reset All
      </button>
      
      <button class="btn btn-primary" (click)="downloadProctorAssignmentsCSV()">
        <mat-icon>download</mat-icon>
        Download CSV
      </button>

      <button 
      class="btn"
      [class.btn-warning]="getTotalConflicts() > 0"
      [class.btn-success]="getTotalConflicts() === 0"
      (click)="showConflictPanel = true">
      <mat-icon>{{ getTotalConflicts() > 0 ? 'warning' : 'check_circle' }}</mat-icon>
      View Conflicts
      <span class="badge" *ngIf="getTotalConflicts() > 0">{{ getTotalConflicts() }}</span>
    </button>

     <button class="btn btn-success" (click)="autoAssignAllProctors()">
      <mat-icon>auto_fix_high</mat-icon>
      Auto-Assign All Proctors
    </button>


    </div>


     
    
  </div>

  <!-- Enhanced Summary with Legend -->
  <div class="proctor-summary">
    <div class="summary-header">
      <h3>
        <mat-icon>assessment</mat-icon>
        Assignment Overview
      </h3>
      
    </div>

    <div class="summary-stats">
      <div class="stat-card">
        <mat-icon>assignment</mat-icon>
        <div class="stat-content">
          <span class="stat-number">{{ totalExams }}</span>
          <span class="stat-label">Total Exams</span>
        </div>
      </div>
      
      <div class="stat-card success">
        <mat-icon>check_circle</mat-icon>
        <div class="stat-content">
          <span class="stat-number">{{ assignedExams }}</span>
          <span class="stat-label">Assigned</span>
        </div>
      </div>
      
      <!-- <div class="stat-card warning">
        <mat-icon>warning</mat-icon>
        <div class="stat-content">
          <span class="stat-number">{{ conflictExams }}</span>
          <span class="stat-label">Conflicts (TBD)</span>
        </div>
      </div> -->
      
      <div class="stat-card">
        <mat-icon>people</mat-icon>
        <div class="stat-content">
          <span class="stat-number">{{ totalProctors }}</span>
          <span class="stat-label">Proctors</span>
        </div>
      </div>
    </div>
  </div>

<!-- Enhanced Filter Section with Proper Bindings -->
<div class="enhanced-filter-section">
  <!-- Search Bar -->
  <div class="filter-row">
    <mat-form-field appearance="outline" class="search-field-wide">
      <mat-label>üîç Search exams...</mat-label>
      <input 
        matInput 
        [(ngModel)]="proctorSearchQuery"
        (ngModelChange)="applyProctorFilters()"
        placeholder="Search by code, room, instructor, day, subject"
      />
      
      <mat-select 
  [(ngModel)]="selectedProctorDept"
  (selectionChange)="applyProctorFilters()">
  <!-- options -->
</mat-select>

      <button mat-icon-button matSuffix *ngIf="proctorSearchQuery" (click)="proctorSearchQuery=''; applyProctorFilters()">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
  </div>

  <!-- Department & Subject Filters -->
  <!-- <div class="filter-row">
    <div class="filter-group">
      <mat-form-field appearance="outline">
        <mat-label>üèõÔ∏è Filter by Program Department</mat-label>
        <mat-select 
          [(ngModel)]="selectedProctorDept"
          (selectionChange)="applyProctorFilters()">
          <mat-option value="">Program Departments </mat-option>
          <mat-option *ngFor="let dept of uniqueCourseDepartments" [value]="dept">
            {{ dept }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <div class="filter-group">
      <mat-form-field appearance="outline">
        <mat-label>üèõÔ∏è Filter by Subject Department</mat-label>
        <mat-select 
          [(ngModel)]="selectedSubjectDept"
          (selectionChange)="applyProctorFilters()">
          <mat-option value="">Subject Departments  </mat-option>
          <mat-option *ngFor="let dept of uniqueInstructorDepartments" [value]="dept">
            {{ dept }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <div class="filter-group">
      <mat-form-field appearance="outline">
        <mat-label>üìö Filter by Subject</mat-label>
        <mat-select 
          [(ngModel)]="selectedProctorSubject"
          (selectionChange)="applyProctorFilters()">
          <mat-option value="">All Subjects</mat-option>
          <mat-option *ngFor="let subject of uniqueSubjectsTaught" [value]="subject">
            {{ subject }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <button 
      class="btn btn-outline-sm" 
      (click)="clearProctorFilters()"
      *ngIf="selectedProctorDept || selectedProctorSubject || proctorSearchQuery">
      <mat-icon>clear_all</mat-icon>
      Clear Filters
    </button>
  </div> -->

  <!-- Toggle Smart Suggestions -->
  <div class="filter-row">
    <mat-slide-toggle 
      [(ngModel)]="showProctorSuggestions"
      (change)="onSmartSuggestionsToggle($event)"
      color="primary">
      Show Smart Suggestions (prioritizes same subject/dept proctors)
    </mat-slide-toggle>
  </div>
</div>

<div class="table-container">
  
  <!-- CATEGORY LABELS -->
  

  <!-- SINGLE TABLE WITH VIRTUAL SCROLL -->
  <cdk-virtual-scroll-viewport 
    itemSize="70" 
    class="proctor-viewport"
    *ngIf="filteredProctorListEnhanced && filteredProctorListEnhanced.length > 0; else noData">
    
    <table class="enhanced-proctor-table">
      <!-- STICKY THEAD -->
      <thead class="sticky-header">
        <tr>
          <th style="width: 80px; min-width: 80px; max-width: 80px;">Day</th>
          <th style="width: 100px; min-width: 100px; max-width: 100px;">Time</th>
          <th style="width: 80px; min-width: 80px; max-width: 80px;">Room</th>
          <th style="width: 120px; min-width: 120px; max-width: 120px;">Code</th>
          <th style="width: 150px; min-width: 150px; max-width: 150px;">Subject</th>
          <th style="width: 100px; min-width: 100px; max-width: 100px;">Course</th>
          <th style="width: 150px; min-width: 150px; max-width: 150px;">Program Dept</th>
          <th style="width: 150px; min-width: 150px; max-width: 150px;">Instructor</th>
          <th style="width: 100px; min-width: 100px; max-width: 100px;">Subject Dept</th>
          <th style="width: 250px; min-width: 250px; max-width: 250px;">Assigned Proctor</th>
          <th style="width: 80px; min-width: 80px; max-width: 80px;">Match</th>
          <th style="width: 120px; min-width: 120px; max-width: 120px;">Status</th>
        </tr>
      </thead>

      <!-- SCROLLABLE TBODY -->
      <tbody>
        <tr *cdkVirtualFor="let exam of filteredProctorListEnhanced; trackBy: trackByExamCode"
         [class.conflict-row]="exam.HAS_PROCTOR_CONFLICT">

         <td style="width: 80px;">
    <mat-icon *ngIf="exam.HAS_PROCTOR_CONFLICT" 
              class="conflict-indicator-small" 
              title="Conflict">
      warning
    </mat-icon>
    {{ exam.DAY }}
  </td>
          <!-- <td style="width: 80px; min-width: 80px; max-width: 80px;">{{ exam.DAY }}</td> -->
          <td style="width: 100px; min-width: 100px; max-width: 100px;">{{ getMergedSlotForDisplay(exam) }}</td>
          <td style="width: 80px; min-width: 80px; max-width: 80px;"><strong>{{ exam.ROOM }}</strong></td>

          <td style="width: 120px; min-width: 120px; max-width: 120px;">
  <strong>{{ exam.CODE }}</strong>
  <span *ngIf="exam.SECTIONS_COUNT && exam.SECTIONS_COUNT > 1" 
        class="section-badge"
        [title]="'Sections: ' + exam.GROUPED_CODES?.join(', ')">
    {{ exam.SECTIONS_COUNT }} sections
  </span>
</td>
          <td style="width: 150px; min-width: 150px; max-width: 150px;" class="truncate" [title]="exam.DESCRIPTIVE_TITLE">
            {{ exam.SUBJECT_ID }}
          </td>
          <td style="width: 100px; min-width: 100px; max-width: 100px;">{{ exam.COURSE }}</td>
          <td style="width: 150px; min-width: 150px; max-width: 150px;">{{ exam.DEPT_SUB }}</td>
          <td style="width: 150px; min-width: 150px; max-width: 150px;">{{ exam.INSTRUCTOR }}</td>
          <td style="width: 100px; min-width: 100px; max-width: 100px;">{{ exam.DEPT }}</td>
          
          <!-- Proctor Dropdown -->
          <td style="width: 250px; min-width: 250px; max-width: 250px;" class="proctor-cell">
            <mat-form-field appearance="outline" class="compact-field">
              <mat-select 
                [value]="exam.PROCTOR"
                (selectionChange)="assignProctorSmart(exam, $event.value)"
                placeholder="Select Proctor">
                
                <!-- Current Assignment -->
                <mat-option 
                  *ngIf="exam.PROCTOR && exam.PROCTOR !== 'TBD' && exam.PROCTOR !== ''" 
                  [value]="exam.PROCTOR"
                  class="current-assignment">
                  <strong>‚úì {{ exam.PROCTOR }}</strong>
                  <span class="current-badge">Current</span>
                </mat-option>
                
                <mat-divider *ngIf="exam.PROCTOR && exam.PROCTOR !== 'TBD' && exam.PROCTOR !== ''"></mat-divider>
                
                <!-- Smart Suggestions -->
                <ng-container *ngIf="showProctorSuggestions">
                  <ng-container *ngIf="getSmartProctorSuggestions(exam).sameSubject.length > 0">
                    <mat-optgroup label="üéØ Best Match: Same Subject">
                      <mat-option 
                        *ngFor="let p of getSmartProctorSuggestions(exam).sameSubject" 
                        [value]="p">
                        {{ p }} <span class="dept-tag">{{ getInstructorDepartment(p) }}</span>
                      </mat-option>
                    </mat-optgroup>
                  </ng-container>

                  <ng-container *ngIf="getSmartProctorSuggestions(exam).sameDept.length > 0">
                    <mat-optgroup label="üèõÔ∏è Good Match: Same Dept">
                      <mat-option 
                        *ngFor="let p of getSmartProctorSuggestions(exam).sameDept" 
                        [value]="p">
                        {{ p }} <span class="dept-tag">{{ getInstructorDepartment(p) }}</span>
                      </mat-option>
                    </mat-optgroup>
                  </ng-container>

                  <ng-container *ngIf="getSmartProctorSuggestions(exam).available.length > 0">
                    <mat-optgroup label="‚úì Available">
                      <mat-option 
                        *ngFor="let p of getSmartProctorSuggestions(exam).available" 
                        [value]="p">
                        {{ p }} <span class="dept-tag">{{ getInstructorDepartment(p) }}</span>
                      </mat-option>
                    </mat-optgroup>
                  </ng-container>
                </ng-container>

                <!-- Simple List -->
                <ng-container *ngIf="!showProctorSuggestions">
                  <mat-option 
                    *ngFor="let p of getAllProctorsForDropdown(exam)" 
                    [value]="p"
                    [disabled]="p === 'No available instructor'">
                    {{ p }}
                  </mat-option>
                </ng-container>
              </mat-select>
            </mat-form-field>
          </td>

          <!-- Match Badge -->
          <td style="width: 80px; min-width: 80px; max-width: 80px;">
            <span *ngIf="exam.PROCTOR && exam.PROCTOR !== 'TBD'" class="match-badge">
              ‚úì
            </span>
          </td>

          <!-- Status Badge -->
          <td style="width: 120px; min-width: 120px; max-width: 120px;">
            <span *ngIf="!exam.HAS_PROCTOR_CONFLICT && exam.PROCTOR && exam.PROCTOR !== 'TBD'" 
                  class="status-badge status-ok">
              ‚úì Assigned
            </span>
            <span *ngIf="exam.HAS_PROCTOR_CONFLICT" class="status-badge status-conflict">
              ‚ö† Conflict
            </span>
            <span *ngIf="!exam.PROCTOR || exam.PROCTOR === 'TBD'" 
                  class="status-badge status-pending">
              ‚óã Pending
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </cdk-virtual-scroll-viewport>

  <!-- NO DATA TEMPLATE -->
  <ng-template #noData>
    <div class="no-data-message">
      <mat-icon>inbox</mat-icon>
      <p>No exams to display</p>
      <p class="debug-info">Total exams: {{ generatedSchedule?.length || 0 }}</p>
      <p class="debug-info">Filtered exams: {{ filteredProctorListEnhanced?.length || 0 }}</p>
    </div>
  </ng-template>
</div>

  <!-- Enhanced Proctor Assignment Table -->
 

  <!-- Proctor Info Panel (Optional - shows details about selected proctor) -->
  <div class="proctor-info-panel" *ngIf="selectedProctorDept || selectedProctorSubject">
    <h4>
      <mat-icon>info</mat-icon>
      Filter Active
    </h4>
    <div class="info-content">
      <p *ngIf="selectedProctorDept">
        <strong>Department:</strong> {{ selectedProctorDept }}
      </p>
      <p *ngIf="selectedProctorSubject">
        <strong>Subject:</strong> {{ selectedProctorSubject }}
      </p>
      <p>
        <strong>Showing:</strong> {{ filteredProctorListEnhanced.length }} of {{ generatedSchedule.length }} exams
      </p>
    </div>
  </div>

<div *ngIf="showConflictPanel" class="conflict-overlay" (click)="showConflictPanel = false">
  <div class="conflict-panel" (click)="$event.stopPropagation()">
    <div class="conflict-header">
      <h2>
        <mat-icon>warning</mat-icon>
        {{ currentStep === 'generate' ? 'Schedule Conflicts' : 'Proctor Conflicts' }}
      </h2>
      <button class="btn-close" (click)="showConflictPanel = false">‚úï</button>
    </div>

    <div class="conflict-content">
      
      <!-- ROOM CONFLICTS (Show in Generated Schedule view) -->
      <div class="conflict-section critical" 
           *ngIf="currentStep === 'generate' && conflictDetails.roomConflicts.length > 0">
        <h3>
          <mat-icon class="conflict-icon">meeting_room</mat-icon>
          Room Conflicts ({{ conflictDetails.roomConflicts.length }})
        </h3>
        <p class="conflict-description critical-text">
          üö® CRITICAL: Same room assigned to multiple exams at the same time
        </p>
        
        <div class="conflict-item" *ngFor="let conflict of conflictDetails.roomConflicts">
          <div class="conflict-item-header">
            <strong>Room {{ conflict.room }}</strong>
            <span class="conflict-time">{{ conflict.day }} | {{ conflict.slot }}</span>
          </div>
          <div class="conflict-exams">
            <div class="conflict-exam-card" *ngFor="let exam of conflict.exams">
              <span class="exam-code">{{ exam.CODE }}</span>
              <span class="exam-title">{{ exam.DESCRIPTIVE_TITLE }}</span>
              <span class="exam-course">{{ exam.COURSE }}</span>
              <span class="exam-instructor">{{ exam.INSTRUCTOR }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- PROCTOR CONFLICTS (Show in Proctor view) -->
      <div class="conflict-section" 
           *ngIf="currentStep === 'proctor' && conflictDetails.proctorConflicts.length > 0">
        <h3>
          <mat-icon class="conflict-icon">person_off</mat-icon>
          Proctor Conflicts ({{ conflictDetails.proctorConflicts.length }})
        </h3>
        <p class="conflict-description">
          Same proctor assigned to multiple exams at the same time
        </p>
        
        <div class="conflict-item" *ngFor="let conflict of conflictDetails.proctorConflicts">
          <div class="conflict-item-header">
            <strong>{{ conflict.proctor }}</strong>
            <span class="conflict-time">{{ conflict.day }} | {{ conflict.slot }}</span>
          </div>
          <div class="conflict-exams">
            <div class="conflict-exam-card" *ngFor="let exam of conflict.exams">
              <span class="exam-code">{{ exam.CODE }}</span>
              <span class="exam-title">{{ exam.DESCRIPTIVE_TITLE }}</span>
              <span class="exam-room">Room {{ exam.ROOM }}</span>
              <span class="exam-course">{{ exam.COURSE }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- NO CONFLICTS -->
      <div class="no-conflicts" *ngIf="getTotalConflicts() === 0">
        <mat-icon class="success-icon">check_circle</mat-icon>
        <h3>No Conflicts Found!</h3>
        <p *ngIf="currentStep === 'generate'">
          All exams are properly scheduled. No room conflicts detected.
        </p>
        <p *ngIf="currentStep === 'proctor'">
          All proctors are properly assigned. No conflicts detected.
        </p>
      </div>
    </div>
  </div>
</div>
   

</div>


<!-- Unscheduled Exams Button (Floating) -->
<div *ngIf="getUnscheduledCount() > 0" 
     style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
  <button 
    (click)="toggleUnscheduledPanel()"
    style="
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 15px 25px;
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
    "
    onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(239, 68, 68, 0.6)';"
    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 15px rgba(239, 68, 68, 0.4)';">
    <span style="
      background: white;
      color: #ef4444;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
    ">{{ getUnscheduledCount() }}</span>
    Unscheduled Exams
  </button>
</div>

<!-- Unscheduled Exams Panel (Sliding) -->
<div *ngIf="showUnscheduledPanel" 
     style="
       position: fixed;
       top: 0;
       right: 0;
       width: 600px;
       height: 100vh;
       background: white;
       box-shadow: -5px 0 30px rgba(0, 0, 0, 0.3);
       z-index: 1001;
       display: flex;
       flex-direction: column;
       animation: slideIn 0.3s ease-out;
     ">
  
  <!-- Panel Header -->
  <div style="
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    padding: 20px 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  ">
    <div>
      <h2 style="margin: 0; font-size: 20px; font-weight: bold;">
        Unscheduled Exams
      </h2>
      <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">
        {{ getUnscheduledCount() }} exam(s) need manual scheduling
      </p>
    </div>
    <button 
      (click)="toggleUnscheduledPanel()"
      style="
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
      "
      onmouseover="this.style.background='rgba(255, 255, 255, 0.3)';"
      onmouseout="this.style.background='rgba(255, 255, 255, 0.2)';">
      ‚úï
    </button>
  </div>

  <!-- Panel Content (Scrollable) -->
  <div style="
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: #f9fafb;
  ">
    
    <!-- Empty State -->
    <div *ngIf="unscheduledExams.length === 0" 
         style="
           text-align: center;
           padding: 60px 20px;
           color: #6b7280;
         ">
      <div style="font-size: 64px; margin-bottom: 20px;">‚úì</div>
      <h3 style="margin: 0 0 10px 0; color: #22c55e;">All Exams Scheduled!</h3>
      <p style="margin: 0;">No unscheduled exams remaining.</p>
    </div>

    <!-- Unscheduled Exams List -->
    <div *ngFor="let exam of unscheduledExams; let i = index" 
         style="
           background: white;
           border-radius: 12px;
           padding: 20px;
           margin-bottom: 15px;
           box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
           border-left: 4px solid #ef4444;
         ">
      
      <!-- Exam Info (View Mode) -->
      <div *ngIf="editingUnscheduledIndex !== i">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
          <div style="flex: 1;">
            <div style="
              background: #fee2e2;
              color: #dc2626;
              padding: 4px 12px;
              border-radius: 6px;
              display: inline-block;
              font-weight: bold;
              font-size: 14px;
              margin-bottom: 10px;
            ">
              {{ exam.code }}
            </div>
            <h4 style="margin: 0 0 8px 0; color: #111827; font-size: 16px; line-height: 1.4;">
              {{ exam.title }}
            </h4>
            <div style="display: flex; gap: 15px; font-size: 13px; color: #6b7280;">
              <span><strong>Subject:</strong> {{ exam.subjectId }}</span>
              <span><strong>Course:</strong> {{ exam.course }}</span>
              <span><strong>Year:</strong> {{ exam.yearLevel }}</span>
            </div>
            <div style="margin-top: 8px; font-size: 13px; color: #6b7280;">
              <span><strong>Instructor:</strong> {{ exam.instructor }}</span>
              <span style="margin-left: 15px;"><strong>Units:</strong> {{ exam.lec + exam.oe }}</span>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 10px; margin-top: 15px;">
          <button 
            (click)="startManualSchedule(i)"
            style="
              flex: 1;
              background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
              color: white;
              border: none;
              border-radius: 8px;
              padding: 10px;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
            "
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)';"
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
            üìÖ Schedule Manually
          </button>
          <button 
            (click)="removeUnscheduledExam(i)"
            style="
              background: #fee2e2;
              color: #dc2626;
              border: none;
              border-radius: 8px;
              padding: 10px 15px;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
            "
            onmouseover="this.style.background='#fecaca';"
            onmouseout="this.style.background='#fee2e2';">
            üóëÔ∏è
          </button>
        </div>
      </div>

      <!-- Exam Editing Form -->
      <div *ngIf="editingUnscheduledIndex === i">
        <div style="margin-bottom: 15px;">
          <div style="
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 12px;
            border-radius: 6px;
            display: inline-block;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 10px;
          ">
            {{ exam.code }}
          </div>
          <h4 style="margin: 0 0 5px 0; color: #111827; font-size: 15px;">
            {{ exam.title }}
          </h4>
          <p style="margin: 0; font-size: 13px; color: #6b7280;">
            {{ exam.course }} - Year {{ exam.yearLevel }}
          </p>
        </div>

        <!-- Day Selection -->
        <div style="margin-bottom: 15px;">
          <label style="
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 13px;
          ">
            üìÖ Select Day
          </label>
          <select 
            [(ngModel)]="manualScheduleData.day"
            style="
              width: 100%;
              padding: 10px;
              border: 2px solid #e5e7eb;
              border-radius: 8px;
              font-size: 14px;
              cursor: pointer;
              transition: border-color 0.2s;
            "
            onfocus="this.style.borderColor='#3b82f6';"
            onblur="this.style.borderColor='#e5e7eb';">
            <option value="">-- Choose Day --</option>
            <option *ngFor="let day of days" [value]="day">{{ day }}</option>
          </select>
        </div>

        <!-- Time Slot Selection -->
        <div style="margin-bottom: 15px;">
          <label style="
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 13px;
          ">
            ‚è∞ Select Time Slot
          </label>
          <select 
            [(ngModel)]="manualScheduleData.slot"
            [disabled]="!manualScheduleData.day"
            style="
              width: 100%;
              padding: 10px;
              border: 2px solid #e5e7eb;
              border-radius: 8px;
              font-size: 14px;
              cursor: pointer;
              transition: border-color 0.2s;
            "
            [style.opacity]="!manualScheduleData.day ? '0.5' : '1'"
            onfocus="this.style.borderColor='#3b82f6';"
            onblur="this.style.borderColor='#e5e7eb';">
            <option value="">-- Choose Time Slot --</option>
            <option *ngFor="let slot of timeSlots" [value]="slot">{{ slot }}</option>
          </select>
        </div>

        <!-- Room Selection -->
        <div style="margin-bottom: 15px;">
          <label style="
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 13px;
          ">
            üèõÔ∏è Select Room
          </label>
          <select 
            [(ngModel)]="manualScheduleData.room"
            [disabled]="!manualScheduleData.day || !manualScheduleData.slot"
            style="
              width: 100%;
              padding: 10px;
              border: 2px solid #e5e7eb;
              border-radius: 8px;
              font-size: 14px;
              cursor: pointer;
              transition: border-color 0.2s;
            "
            [style.opacity]="(!manualScheduleData.day || !manualScheduleData.slot) ? '0.5' : '1'"
            onfocus="this.style.borderColor='#3b82f6';"
            onblur="this.style.borderColor='#e5e7eb';">
            <option value="">-- Choose Room --</option>
            <option 
              *ngFor="let room of getAvailableRoomsForManualSchedule(manualScheduleData.day, manualScheduleData.slot)" 
              [value]="room">
              {{ room }}
            </option>
          </select>
          <p *ngIf="manualScheduleData.day && manualScheduleData.slot" 
             style="margin: 8px 0 0 0; font-size: 12px; color: #6b7280;">
            {{ getSlotInfo(manualScheduleData.day, manualScheduleData.slot) }}
          </p>
        </div>

        <!-- Conflict Warning -->
        <div *ngIf="manualScheduleData.day && manualScheduleData.slot && hasCoursConflictForManualSchedule(exam, manualScheduleData.day, manualScheduleData.slot)"
             style="
               background: #fef3c7;
               border-left: 4px solid #f59e0b;
               padding: 12px;
               border-radius: 8px;
               margin-bottom: 15px;
             ">
          <p style="margin: 0; font-size: 13px; color: #92400e;">
            ‚ö†Ô∏è <strong>Course Conflict:</strong> This course already has an exam at this time.
          </p>
        </div>

        <!-- Save/Cancel Buttons -->
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button 
            (click)="saveManualSchedule(i)"
            style="
              flex: 1;
              background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
              color: white;
              border: none;
              border-radius: 8px;
              padding: 12px;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
            "
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(34, 197, 94, 0.4)';"
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
            ‚úì Save Schedule
          </button>
          <button 
            (click)="cancelManualSchedule()"
            style="
              flex: 1;
              background: #f3f4f6;
              color: #374151;
              border: none;
              border-radius: 8px;
              padding: 12px;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
            "
            onmouseover="this.style.background='#e5e7eb';"
            onmouseout="this.style.background='#f3f4f6';">
            ‚úï Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Overlay (for closing panel) -->
<div *ngIf="showUnscheduledPanel"
     (click)="toggleUnscheduledPanel()"
     style="
       position: fixed;
       top: 0;
       left: 0;
       width: 100%;
       height: 100%;
       background: rgba(0, 0, 0, 0.5);
       z-index: 1000;
       animation: fadeIn 0.3s ease-out;
     ">
</div>

<!-- ============================================================================ -->
<!-- ADD THESE STYLES TO YOUR scheduler.component.scss OR styles.scss -->
<!-- ============================================================================ -->
<style>
@keyframes slideIn {
  from {
    transform: translateX(100%);
  }
  to {
    transform: translateX(0);
  }
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Custom scrollbar for panel */
div[style*="overflow-y: auto"]::-webkit-scrollbar {
  width: 8px;
}

div[style*="overflow-y: auto"]::-webkit-scrollbar-track {
  background: #f1f1f1;
}

div[style*="overflow-y: auto"]::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 4px;
}

div[style*="overflow-y: auto"]::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}
</style>


</div>